<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Keyholder - Visible Fix</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            overflow: hidden; 
            background: #000;
        }
        
        #ar-scene { 
            width: 100vw; 
            height: 100vh; 
        }
        
        #status-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        
        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .status-ok { color: #4ade80; }
        .status-error { color: #f87171; }
        .status-warning { color: #fbbf24; }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .marker-link {
            color: #60a5fa;
            text-decoration: none;
            margin-top: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- ステータス表示 -->
    <div id="status-overlay">
        <h3>🎯 AR Keyholder</h3>
        <div class="status-item" id="camera-status">📷 カメラ: <span class="status-ok">アクティブ</span></div>
        <div class="status-item" id="ar-status">🔍 AR: <span class="status-ok">準備完了</span></div>
        <div class="status-item" id="marker-status">📍 マーカー: 検出待機中</div>
        <div class="status-item" id="visibility-status">👁️ 表示: <span class="status-warning">待機中</span></div>
    </div>
    
    <!-- 使用方法 -->
    <div id="instructions">
        <strong>📖 使用方法:</strong><br>
        1. <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" 
              target="_blank" class="marker-link">Hiroマーカー</a>を表示<br>
        2. マーカーをカメラに向けてください<br>
        3. 大きな3Dキーホルダーが表示されます！
    </div>

    <!-- AR.js Scene - 視認性最優先 -->
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true; alpha: true; sortObjects: true; physicallyCorrectLights: true;"
        embedded
        arjs="
            trackingMethod: best; 
            sourceType: webcam; 
            debugUIEnabled: false; 
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3;
            sourceWidth: 640;
            sourceHeight: 480;
            displayWidth: 640;
            displayHeight: 480;
            maxDetectionRate: 60;
            canvasWidth: 640;
            canvasHeight: 480;
            positionRatioAccuracy: 1000;
            minConfidence: 0.6;
        "
        loading-screen="enabled: false">
        
        <!-- Hiroマーカー -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
            raycaster="objects: .raycastable"
            cursor="rayOrigin: mouse">
            
            <!-- 3Dキーホルダーオブジェクト - 完全中央配置 -->
            <a-entity id="keyholder-object" position="0 0 0" rotation="0 0 0" scale="1 1 1">
                
                <!-- 基準点（緑の球） - マーカー中心 -->
                <a-sphere
                    position="0 0 0"
                    radius="0.03"
                    color="#00ff00"
                    material="emissive: #00ff00; emissiveIntensity: 2.0; transparent: true; opacity: 0.8;">
                </a-sphere>
                
                <!-- メインキーホルダーボディ - 中央から上に配置 -->
                <a-box
                    position="0 0.3 0"
                    width="0.4"
                    height="0.5"
                    depth="0.15"
                    color="#ff6b6b"
                    material="color: #ff6b6b; roughness: 0.3; metalness: 0.5; emissive: #ff2222; emissiveIntensity: 0.2;"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
                    
                    <!-- キャラクターの顔 -->
                    <a-sphere
                        position="0 0.15 0.1"
                        radius="0.1"
                        color="#ffeb3b"
                        material="color: #ffeb3b; roughness: 0.8; metalness: 0.1; emissive: #ffff00; emissiveIntensity: 0.3;">
                        
                        <!-- 目 -->
                        <a-sphere position="-0.03 0.025 0.075" radius="0.015" color="#000"></a-sphere>
                        <a-sphere position="0.03 0.025 0.075" radius="0.015" color="#000"></a-sphere>
                        
                        <!-- 笑顔 -->
                        <a-torus 
                            position="0 -0.025 0.075" 
                            radius="0.03" 
                            radius-tubular="0.005" 
                            rotation="0 0 0"
                            color="#000"
                            theta-start="0"
                            theta-length="180">
                        </a-torus>
                    </a-sphere>
                    
                    <!-- 腕 -->
                    <a-sphere position="-0.25 0 0" radius="0.05" color="#ffeb3b"></a-sphere>
                    <a-sphere position="0.25 0 0" radius="0.05" color="#ffeb3b"></a-sphere>
                </a-box>
                
                <!-- キーリング - 中央基準で調整 -->
                <a-torus
                    position="0 0.8 0"
                    color="#c0c0c0"
                    radius="0.2"
                    radius-tubular="0.025"
                    material="color: #c0c0c0; metalness: 1.0; roughness: 0.1; emissive: #888888; emissiveIntensity: 0.4;"
                    animation="property: rotation; to: 360 0 0; loop: true; dur: 6000">
                </a-torus>
                
                <!-- 接続チェーン - 中央基準で調整 -->
                <a-entity id="chain">
                    <a-cylinder position="0 0.7 0" radius="0.01" height="0.05" color="#c0c0c0"></a-cylinder>
                    <a-cylinder position="0 0.65 0" radius="0.01" height="0.05" color="#c0c0c0"></a-cylinder>
                    <a-cylinder position="0 0.6 0" radius="0.01" height="0.05" color="#c0c0c0"></a-cylinder>
                    <a-cylinder position="0 0.55 0" radius="0.01" height="0.05" color="#c0c0c0"></a-cylinder>
                </a-entity>
                
                <!-- デコレーション -->
                <a-cylinder
                    position="0.3 0.5 0"
                    radius="0.03"
                    height="0.1"
                    color="#4ecdc4"
                    material="color: #4ecdc4; metalness: 0.5; roughness: 0.3; emissive: #00cccc; emissiveIntensity: 0.3;"
                    animation="property: position; to: 0.3 0.65 0; dir: alternate; loop: true; dur: 2000">
                </a-cylinder>
                
                <a-cylinder
                    position="-0.3 0.5 0"
                    radius="0.03"
                    height="0.1"
                    color="#ffe66d"
                    material="color: #ffe66d; metalness: 0.5; roughness: 0.3; emissive: #ffcc00; emissiveIntensity: 0.3;"
                    animation="property: position; to: -0.3 0.65 0; dir: alternate; loop: true; dur: 2500">
                </a-cylinder>
                
                <!-- テスト用の巨大な球（デバッグ） - 中央基準 -->
                <a-sphere
                    id="test-sphere"
                    position="0 2.0 0"
                    radius="0.2"
                    color="#ff0000"
                    material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 1.0;"
                    animation="property: scale; to: 1.3 1.3 1.3; dir: alternate; loop: true; dur: 1000"
                    visible="true">
                </a-sphere>
            </a-entity>
        </a-marker>
        
        <!-- 強力なライティング -->
        <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
        <a-light type="directional" position="0 1 0" color="#ffffff" intensity="1.0"></a-light>
        <a-light type="point" position="0 2 1" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- カメラ -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // DOM要素
        const markerStatus = document.getElementById('marker-status');
        const visibilityStatus = document.getElementById('visibility-status');
        
        // ステータス更新関数
        function updateStatus(element, message, type = 'ok') {
            const statusClasses = { ok: 'status-ok', error: 'status-error', warning: 'status-warning' };
            element.innerHTML = element.innerHTML.split(':')[0] + ': ' + 
                `<span class="${statusClasses[type]}">${message}</span>`;
        }
        
        // ARシーン初期化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎯 AR Keyholder - Visibility Fix Version');
            
            const arScene = document.querySelector('a-scene');
            const marker = document.querySelector('#hiro-marker');
            const keyholderObject = document.querySelector('#keyholder-object');
            const testSphere = document.querySelector('#test-sphere');
            
            // マーカー検出イベント
            marker.addEventListener('markerFound', () => {
                console.log('🎯 Hiro marker detected - Making objects VISIBLE!');
                updateStatus(markerStatus, '検出中 - 大きなオブジェクト表示!', 'ok');
                updateStatus(visibilityStatus, '大きく表示中!', 'ok');
                
                // 強制的に可視化
                keyholderObject.setAttribute('visible', true);
                testSphere.setAttribute('visible', true);
                
                // 強烈な出現アニメーション
                keyholderObject.setAttribute('animation__appear', {
                    property: 'scale',
                    from: '0 0 0',
                    to: '2 2 2',
                    dur: 1000,
                    easing: 'easeOutBounce'
                });
                
                // テストスフィアの点滅
                testSphere.setAttribute('animation__blink', {
                    property: 'material.emissiveIntensity',
                    from: '0.8',
                    to: '1.5',
                    dir: 'alternate',
                    loop: true,
                    dur: 500
                });
            });
            
            marker.addEventListener('markerLost', () => {
                console.log('Hiro marker lost');
                updateStatus(markerStatus, '未検出 - マーカーを探しています', 'warning');
                updateStatus(visibilityStatus, '待機中', 'warning');
            });
            
            // AR.js初期化完了イベント
            arScene.addEventListener('arjs-video-loaded', () => {
                console.log('🚀 AR.js video loaded - Ready for BIG objects!');
                updateStatus(markerStatus, '検出待機中', 'warning');
            });
        });
        
        // デバッグ用グローバル関数
        window.ARKeyholder = {
            version: '3.2.0-center-fix',
            forceShow: () => {
                const obj = document.querySelector('#keyholder-object');
                obj.setAttribute('visible', true);
                obj.setAttribute('scale', '3 3 3');
                console.log('Forced visibility ON');
            },
            toggleTestSphere: () => {
                const sphere = document.querySelector('#test-sphere');
                sphere.setAttribute('visible', !sphere.getAttribute('visible'));
            },
            centerObject: () => {
                const obj = document.querySelector('#keyholder-object');
                obj.setAttribute('position', '0 0 0');
                obj.setAttribute('rotation', '0 0 0');
                console.log('Object centered at marker origin');
            },
            adjustPosition: (x, y, z) => {
                const obj = document.querySelector('#keyholder-object');
                obj.setAttribute('position', `${x} ${y} ${z}`);
                console.log(`Position adjusted to: ${x}, ${y}, ${z}`);
            },
            getPosition: () => {
                const obj = document.querySelector('#keyholder-object');
                console.log('Current position:', obj.getAttribute('position'));
                return obj.getAttribute('position');
            },
            loadProject: (projectId) => {
                const url = new URL(window.location);
                url.searchParams.set('project', projectId);
                window.location.href = url.toString();
            }
        };
        
        // Supabase設定
        const SUPABASE_URL = 'https://flqbgdqtphokkekminvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscWJnZHF0cGhva2tla21pbnZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjgyMjIsImV4cCI6MjA2NTE0NDIyMn0.rEXiy6TbMVflwpkDv9z1pMV6lsrmW7ukM81qGj4pfp0';
        const SUPABASE_HEADERS = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY
        };

        // プロジェクトデータの読み込み（Supabase対応）
        async function loadProjectData() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                try {
                    console.log('Loading project from Supabase:', projectId);
                    
                    // Supabaseからプロジェクトデータを取得
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/projects?id=eq.${projectId}&select=*`, {
                        method: 'GET',
                        headers: SUPABASE_HEADERS
                    });
                    
                    let projectData;
                    
                    if (response.ok) {
                        const supabaseProjects = await response.json();
                        console.log('Raw Supabase project data:', supabaseProjects);
                        
                        if (supabaseProjects && supabaseProjects.length > 0) {
                            const supabaseProject = supabaseProjects[0];
                            
                            // Supabaseデータを既存形式に変換
                            projectData = {
                                id: supabaseProject.id,
                                name: supabaseProject.title,
                                metadata: { 
                                    description: supabaseProject.description || '' 
                                },
                                character: {
                                    modelUrl: supabaseProject.model_url || 'keyholder-default',
                                    scale: 1,
                                    position: [0, 0.5, 0]
                                },
                                marker: { 
                                    imageUrl: supabaseProject.image_url || '' 
                                },
                                created_at: supabaseProject.created_at
                            };
                            
                            console.log('Converted project data:', projectData);
                        }
                    } else {
                        console.warn('Supabase fetch failed, trying localStorage');
                    }
                    
                    // フォールバック: ローカルストレージから取得
                    if (!projectData) {
                        const projects = JSON.parse(localStorage.getItem('ar-projects') || '[]');
                        projectData = projects.find(p => p.id === projectId);
                        console.log('Project loaded from localStorage:', projectData);
                    }
                    
                    if (projectData) {
                        await applyProjectSettings(projectData);
                        updateStatus(document.getElementById('ar-status'), `プロジェクト: ${projectData.name}`, 'ok');
                    } else {
                        console.warn('Project not found:', projectId);
                        updateStatus(document.getElementById('ar-status'), 'プロジェクトが見つかりません', 'error');
                    }
                } catch (error) {
                    console.error('Project loading error:', error);
                    updateStatus(document.getElementById('ar-status'), 'プロジェクト読み込みエラー', 'error');
                    
                    // 最終フォールバック
                    try {
                        const projects = JSON.parse(localStorage.getItem('ar-projects') || '[]');
                        const projectData = projects.find(p => p.id === projectId);
                        if (projectData) {
                            await applyProjectSettings(projectData);
                            updateStatus(document.getElementById('ar-status'), `プロジェクト: ${projectData.name} (ローカル)`, 'warning');
                        }
                    } catch (fallbackError) {
                        console.error('Fallback error:', fallbackError);
                    }
                }
            } else {
                console.log('No project ID specified, using default settings');
                updateStatus(document.getElementById('ar-status'), 'デフォルト表示', 'ok');
            }
        }
        
        // プロジェクト設定の適用
        async function applyProjectSettings(projectData) {
            try {
                console.log('Applying project settings:', projectData);
                
                // キャラクターモデルの設定
                if (projectData.character && projectData.character.modelUrl) {
                    const modelUrl = projectData.character.modelUrl;
                    console.log('Loading character model:', modelUrl);
                    
                    if (modelUrl !== 'keyholder-default') {
                        // カスタムモデルを読み込み
                        const keyholderObject = document.querySelector('#keyholder-object');
                        
                        // 既存のデフォルトオブジェクトを削除（非表示ではなく完全に除去）
                        const defaultObjects = keyholderObject.querySelectorAll('a-box, a-sphere:not(#test-sphere), a-torus, a-cylinder, a-entity#chain');
                        defaultObjects.forEach(obj => obj.remove());
                        
                        // Base64データかURLかを判定
                        let modelSrc = modelUrl;
                        if (modelUrl.startsWith('data:application/octet-stream')) {
                            // Base64データの場合はそのまま使用
                            console.log('Loading Base64 GLB model');
                            modelSrc = modelUrl;
                        } else if (modelUrl.startsWith('http')) {
                            // 外部URLの場合
                            console.log('Loading external GLB model from URL');
                            modelSrc = modelUrl;
                        }
                        
                        // GLTFモデルを追加
                        const gltfEntity = document.createElement('a-gltf-model');
                        gltfEntity.setAttribute('src', modelSrc);
                        gltfEntity.setAttribute('position', projectData.character.position ? 
                            `${projectData.character.position[0]} ${projectData.character.position[1]} ${projectData.character.position[2]}` : 
                            '0 0 0');
                        gltfEntity.setAttribute('scale', `${projectData.character.scale || 1} ${projectData.character.scale || 1} ${projectData.character.scale || 1}`);
                        
                        // モデル読み込み完了イベント
                        gltfEntity.addEventListener('model-loaded', () => {
                            console.log('✅ Custom GLB model loaded successfully');
                            updateStatus(document.getElementById('ar-status'), `カスタムモデル読み込み完了: ${projectData.name}`, 'ok');
                        });
                        
                        // エラーハンドリング
                        gltfEntity.addEventListener('model-error', (event) => {
                            console.error('❌ GLB model loading failed:', event.detail);
                            updateStatus(document.getElementById('ar-status'), 'カスタムモデル読み込みエラー', 'error');
                            // エラー時はデフォルトモデルを再作成
                            console.warn('Creating fallback default model...');
                            gltfEntity.remove();
                        });
                        
                        keyholderObject.appendChild(gltfEntity);
                        console.log('Custom GLB model entity created:', modelSrc.substring(0, 100) + '...');
                    }
                }
                
                // プロジェクト情報を表示
                updateStatus(document.getElementById('ar-status'), `プロジェクト: ${projectData.name}`, 'ok');
                
            } catch (error) {
                console.error('Error applying project settings:', error);
                updateStatus(document.getElementById('ar-status'), '設定適用エラー', 'error');
            }
        }
        
        // AR表示回数をカウント
        function incrementViewCount() {
            const currentViews = parseInt(localStorage.getItem('ar-total-views') || '0');
            localStorage.setItem('ar-total-views', (currentViews + 1).toString());
            console.log('AR view count incremented:', currentViews + 1);
        }
        
        // ページ読み込み時にプロジェクトデータを読み込み
        document.addEventListener('DOMContentLoaded', () => {
            loadProjectData();
            incrementViewCount();
        });
    </script>
</body>
</html>