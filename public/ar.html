<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Keyholder - Position Fixed</title>
    <!-- å®‰å®šç‰ˆã®CDNä½¿ç”¨ -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            overflow: hidden; 
            background: #000;
        }
        
        #ar-scene { 
            width: 100vw; 
            height: 100vh; 
        }
        
        #status-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
        }
        
        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .status-ok { color: #4ade80; }
        .status-error { color: #f87171; }
        .status-warning { color: #fbbf24; }
        
        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4ade80;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        #position-controls {
            position: fixed;
            bottom: 180px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 12px;
            display: none;
        }
        
        .position-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        #center-crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            z-index: 500;
            pointer-events: none;
        }
        
        #center-crosshair::before,
        #center-crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }
        
        #center-crosshair::before {
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            transform: translateY(-50%);
        }
        
        #center-crosshair::after {
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            transform: translateX(-50%);
        }
    </style>
</head>
<body>
    <!-- ä¸­å¤®åå­—ç·š -->
    <div id="center-crosshair"></div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen">
        <h2>ğŸ¯ AR Keyholder</h2>
        <p>ä½ç½®ä¿®æ­£ç‰ˆ</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="loading-status">åˆæœŸåŒ–ä¸­...</div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status-overlay" style="display: none;">
        <h3>ğŸ¯ AR Keyholder</h3>
        <div class="status-item" id="camera-status">ğŸ“· ã‚«ãƒ¡ãƒ©: åˆæœŸåŒ–ä¸­</div>
        <div class="status-item" id="ar-status">ğŸ” AR: å¾…æ©Ÿä¸­</div>
        <div class="status-item" id="marker-status">ğŸ“ ãƒãƒ¼ã‚«ãƒ¼: æœªæ¤œå‡º</div>
        <div class="status-item" id="position-status">ğŸ“ ä½ç½®: èª¿æ•´ä¸­</div>
    </div>
    
    <!-- ä½ç½®èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div id="position-controls">
        <div><strong>ä½ç½®å¾®èª¿æ•´:</strong></div>
        <div>
            <button class="position-btn" onclick="adjustPosition('left')">â†</button>
            <button class="position-btn" onclick="adjustPosition('up')">â†‘</button>
            <button class="position-btn" onclick="adjustPosition('down')">â†“</button>
            <button class="position-btn" onclick="adjustPosition('right')">â†’</button>
            <button class="position-btn" onclick="resetPosition()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
    
    <!-- ä½¿ç”¨æ–¹æ³• -->
    <div id="instructions" style="display: none;">
        <strong>ğŸ“– ä½ç½®èª¿æ•´æ–¹æ³•:</strong><br>
        1. ãƒãƒ¼ã‚«ãƒ¼ã‚’ç”»é¢ä¸­å¤®ã®åå­—ç·šã«åˆã‚ã›ã‚‹<br>
        2. 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ºãƒ¬ã¦ã„ã‚‹å ´åˆã¯ä¸Šã®çŸ¢å°ãƒœã‚¿ãƒ³ã§èª¿æ•´<br>
        3. ã€Œãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã§åˆæœŸä½ç½®ã«æˆ»ã‚‹
    </div>

    <!-- AR.js Scene - ä½ç½®ç²¾å¯†èª¿æ•´ -->
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true; alpha: true;"
        embedded
        arjs="
            trackingMethod: best; 
            sourceType: webcam; 
            debugUIEnabled: false; 
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3;
            sourceWidth: 640;
            sourceHeight: 480;
            displayWidth: 640;
            displayHeight: 480;
            maxDetectionRate: 60;
            canvasWidth: 640;
            canvasHeight: 480;
        "
        loading-screen="enabled: false">
        
        <!-- Hiroãƒãƒ¼ã‚«ãƒ¼ - ä½ç½®èª¿æ•´å¯èƒ½ -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2">
            
            <!-- 3Dã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ - åˆæœŸä½ç½®ã‚’å³ã«èª¿æ•´ -->
            <a-entity id="keyholder-object" position="0.3 0 0">
                
                <!-- ã‚»ãƒ³ã‚¿ãƒ¼åŸºæº–ç‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
                <a-sphere 
                    id="center-point"
                    position="0 0 0"
                    radius="0.03"
                    color="#00ff00"
                    material="emissive: #00ff00; emissiveIntensity: 0.8;"
                    visible="true">
                </a-sphere>
                
                <!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ãƒœãƒ‡ã‚£ -->
                <a-box
                    position="0 0.4 0"
                    width="0.5"
                    height="0.7"
                    depth="0.2"
                    color="#ff6b6b"
                    material="roughness: 0.5; metalness: 0.3;"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 12000">
                    
                    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é¡” -->
                    <a-sphere
                        position="0 0.2 0.12"
                        radius="0.1"
                        color="#ffeb3b"
                        material="roughness: 0.8; metalness: 0.1;">
                        
                        <!-- ç›® -->
                        <a-sphere position="-0.03 0.02 0.08" radius="0.012" color="#000"></a-sphere>
                        <a-sphere position="0.03 0.02 0.08" radius="0.012" color="#000"></a-sphere>
                        
                        <!-- å£ -->
                        <a-cylinder 
                            position="0 -0.025 0.08"
                            radius="0.025"
                            height="0.003"
                            rotation="90 0 0"
                            color="#000">
                        </a-cylinder>
                    </a-sphere>
                    
                    <!-- è…• -->
                    <a-sphere position="-0.3 0 0" radius="0.05" color="#ffeb3b"></a-sphere>
                    <a-sphere position="0.3 0 0" radius="0.05" color="#ffeb3b"></a-sphere>
                </a-box>
                
                <!-- ã‚­ãƒ¼ãƒªãƒ³ã‚° -->
                <a-torus
                    position="0 0.8 0"
                    color="#c0c0c0"
                    radius="0.2"
                    radius-tubular="0.025"
                    material="metalness: 0.9; roughness: 0.1;"
                    animation="property: rotation; to: 360 0 0; loop: true; dur: 8000">
                </a-torus>
                
                <!-- ãƒ™ãƒ¼ã‚¹å°åº§ - ãƒãƒ¼ã‚«ãƒ¼ä½ç½®ç¢ºèªç”¨ -->
                <a-cylinder
                    position="0 0.02 0"
                    radius="0.3"
                    height="0.01"
                    color="#333333"
                    material="metalness: 0.8; roughness: 0.2; opacity: 0.8; transparent: true;">
                </a-cylinder>
                
                <!-- ãƒãƒ¼ã‚«ãƒ¼ä¸­å¤®ã‚’ç¤ºã™æŸ± -->
                <a-cylinder
                    position="0 0.1 0"
                    radius="0.01"
                    height="0.2"
                    color="#00ff00"
                    material="emissive: #00ff00; emissiveIntensity: 0.5;">
                </a-cylinder>
            </a-entity>
        </a-marker>
        
        <!-- ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="0 1 0.5" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let arScene, marker, keyholderObject;
        let currentPosition = { x: 0.3, y: 0, z: 0 }; // åˆæœŸä½ç½®ã‚’å³ã«èª¿æ•´
        let initializationComplete = false;
        
        // DOMè¦ç´ 
        const loadingScreen = document.getElementById('loading-screen');
        const statusOverlay = document.getElementById('status-overlay');
        const instructions = document.getElementById('instructions');
        const positionControls = document.getElementById('position-controls');
        const progress = document.getElementById('progress');
        const loadingStatus = document.getElementById('loading-status');
        
        const cameraStatus = document.getElementById('camera-status');
        const arStatus = document.getElementById('ar-status');
        const markerStatus = document.getElementById('marker-status');
        const positionStatus = document.getElementById('position-status');
        
        // ä½ç½®èª¿æ•´é–¢æ•°
        function adjustPosition(direction) {
            const step = 0.1; // èª¿æ•´å¹…
            
            switch(direction) {
                case 'left':
                    currentPosition.x -= step;
                    break;
                case 'right':
                    currentPosition.x += step;
                    break;
                case 'up':
                    currentPosition.y += step;
                    break;
                case 'down':
                    currentPosition.y -= step;
                    break;
            }
            
            updateObjectPosition();
        }
        
        function resetPosition() {
            currentPosition = { x: 0, y: 0, z: 0 }; // å®Œå…¨ãªä¸­å¤®
            updateObjectPosition();
        }
        
        function updateObjectPosition() {
            if (keyholderObject) {
                const posStr = `${currentPosition.x} ${currentPosition.y} ${currentPosition.z}`;
                keyholderObject.setAttribute('position', posStr);
                console.log(`Position updated to: ${posStr}`);
                
                updateStatus(positionStatus, `X:${currentPosition.x.toFixed(1)} Y:${currentPosition.y.toFixed(1)}`, 'ok');
            }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(percentage, message) {
            progress.style.width = percentage + '%';
            loadingStatus.textContent = message;
            console.log(`Progress ${percentage}%: ${message}`);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(element, message, type = 'ok') {
            element.innerHTML = element.innerHTML.split(':')[0] + ': ' + 
                `<span class="status-${type}">${message}</span>`;
        }
        
        // ARåˆæœŸåŒ–
        function initializeAR() {
            console.log('Starting position-adjustable AR...');
            updateProgress(25, 'A-Frameã‚’åˆæœŸåŒ–ä¸­...');
            
            if (typeof AFRAME !== 'undefined') {
                setupARScene();
            } else {
                setTimeout(initializeAR, 100);
            }
        }
        
        function setupARScene() {
            updateProgress(50, 'ARã‚·ãƒ¼ãƒ³ã‚’è¨­å®šä¸­...');
            
            arScene = document.querySelector('a-scene');
            marker = document.querySelector('#hiro-marker');
            keyholderObject = document.querySelector('#keyholder-object');
            
            if (!arScene || !marker) {
                setTimeout(setupARScene, 100);
                return;
            }
            
            // AR.jsã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            arScene.addEventListener('arjs-video-loaded', () => {
                console.log('ğŸ‰ AR video loaded - position adjustment ready!');
                updateStatus(arStatus, 'ã‚«ãƒ¡ãƒ©æ˜ åƒå–å¾—æˆåŠŸ', 'ok');
                updateProgress(100, 'ARåˆæœŸåŒ–å®Œäº†ï¼');
                
                setTimeout(showARInterface, 500);
                initializationComplete = true;
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
            marker.addEventListener('markerFound', () => {
                console.log('ğŸ¯ Hiro marker detected - showing position controls!');
                updateStatus(markerStatus, 'æ¤œå‡ºä¸­ - ä½ç½®èª¿æ•´å¯èƒ½!', 'ok');
                
                // ä½ç½®èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                positionControls.style.display = 'block';
                
                // åˆæœŸä½ç½®ã‚’é©ç”¨
                updateObjectPosition();
            });
            
            marker.addEventListener('markerLost', () => {
                console.log('Hiro marker lost');
                updateStatus(markerStatus, 'æœªæ¤œå‡º', 'warning');
                updateStatus(positionStatus, 'èª¿æ•´ä¸­', 'warning');
                
                // ä½ç½®èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
                positionControls.style.display = 'none';
            });
            
            updateProgress(75, 'ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...');
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                if (!initializationComplete) {
                    console.log('Forcing AR interface display...');
                    showARInterface();
                }
            }, 10000);
        }
        
        function showARInterface() {
            updateStatus(cameraStatus, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'ok');
            updateStatus(arStatus, 'æº–å‚™å®Œäº†', 'ok');
            
            loadingScreen.style.display = 'none';
            statusOverlay.style.display = 'block';
            instructions.style.display = 'block';
            
            console.log('ğŸš€ Position-adjustable AR interface ready!');
        }
        
        // åˆæœŸåŒ–é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ AR Keyholder - Position Adjustment Version');
            
            updateProgress(10, 'ä½ç½®èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
            updateStatus(cameraStatus, 'æº–å‚™ä¸­...', 'warning');
            
            setTimeout(initializeAR, 500);
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        window.ARKeyholder = {
            version: '2.2.0-position-fix',
            adjustLeft: () => adjustPosition('left'),
            adjustRight: () => adjustPosition('right'),
            adjustUp: () => adjustPosition('up'),
            adjustDown: () => adjustPosition('down'),
            reset: resetPosition,
            setPosition: (x, y, z) => {
                currentPosition = { x, y, z };
                updateObjectPosition();
            },
            getPosition: () => currentPosition
        };
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowLeft':
                    adjustPosition('left');
                    break;
                case 'ArrowRight':
                    adjustPosition('right');
                    break;
                case 'ArrowUp':
                    adjustPosition('up');
                    break;
                case 'ArrowDown':
                    adjustPosition('down');
                    break;
                case 'r':
                case 'R':
                    resetPosition();
                    break;
            }
        });
    </script>
</body>
</html>