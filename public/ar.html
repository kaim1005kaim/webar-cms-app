<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Keyholder - iOS Optimized</title>
    <!-- å®‰å®šç‰ˆã®CDNä½¿ç”¨ -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            overflow: hidden; 
            background: #000;
        }
        
        #ar-scene { 
            width: 100vw; 
            height: 100vh; 
        }
        
        #status-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
        }
        
        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .status-ok { color: #4ade80; }
        .status-error { color: #f87171; }
        .status-warning { color: #fbbf24; }
        
        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4ade80;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .marker-link {
            color: #60a5fa;
            text-decoration: none;
            margin-top: 10px;
            display: inline-block;
        }
        
        .error-details {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: left;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen">
        <h2>AR Keyholder</h2>
        <p>iOS Safariæœ€é©åŒ–ç‰ˆ</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="loading-status">åˆæœŸåŒ–ä¸­...</div>
        <div id="error-details" class="error-details" style="display: none;"></div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status-overlay" style="display: none;">
        <h3>ğŸ¯ AR Keyholder</h3>
        <div class="status-item" id="camera-status">ğŸ“· ã‚«ãƒ¡ãƒ©: åˆæœŸåŒ–ä¸­</div>
        <div class="status-item" id="ar-status">ğŸ” AR: å¾…æ©Ÿä¸­</div>
        <div class="status-item" id="marker-status">ğŸ“ ãƒãƒ¼ã‚«ãƒ¼: æœªæ¤œå‡º</div>
        <div class="status-item" id="device-status">ğŸ“± ãƒ‡ãƒã‚¤ã‚¹: <span class="status-ok">iOS Safari</span></div>
    </div>
    
    <!-- ä½¿ç”¨æ–¹æ³• -->
    <div id="instructions" style="display: none;">
        <strong>ğŸ“– ä½¿ç”¨æ–¹æ³•:</strong><br>
        1. ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„<br>
        2. <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" 
              target="_blank" class="marker-link">Hiroãƒãƒ¼ã‚«ãƒ¼</a>ã‚’å°åˆ·<br>
        3. ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„
    </div>

    <!-- AR.js Scene - iOSæœ€é©åŒ–è¨­å®š -->
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true; alpha: true; precision: medium;"
        embedded
        arjs="
            trackingMethod: best; 
            sourceType: webcam; 
            debugUIEnabled: false; 
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3;
            sourceWidth: 640;
            sourceHeight: 480;
            displayWidth: 640;
            displayHeight: 480;
            maxDetectionRate: 30;
            canvasWidth: 640;
            canvasHeight: 480;
        "
        loading-screen="enabled: false">
        
        <!-- Hiroãƒãƒ¼ã‚«ãƒ¼ -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2">
            
            <!-- ã‚·ãƒ³ãƒ—ãƒ«ãª3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆiOSæœ€é©åŒ–ï¼‰ -->
            <a-entity id="keyholder-object">
                <!-- ãƒ¡ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹ -->
                <a-box
                    position="0 0.5 0"
                    width="0.6"
                    height="0.8"
                    depth="0.2"
                    color="#ff6b6b"
                    material="roughness: 0.5; metalness: 0.3;"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
                    
                    <!-- é¡” -->
                    <a-sphere
                        position="0 0.2 0.15"
                        radius="0.12"
                        color="#ffeb3b"
                        material="roughness: 0.8; metalness: 0.1;">
                        
                        <!-- ç›® -->
                        <a-sphere position="-0.04 0.04 0.08" radius="0.015" color="#000"></a-sphere>
                        <a-sphere position="0.04 0.04 0.08" radius="0.015" color="#000"></a-sphere>
                        
                        <!-- å£ -->
                        <a-box position="0 -0.04 0.08" width="0.05" height="0.008" depth="0.008" color="#000"></a-box>
                    </a-sphere>
                </a-box>
                
                <!-- ãƒªãƒ³ã‚° -->
                <a-torus
                    position="0 1.0 0"
                    color="#c0c0c0"
                    radius="0.3"
                    radius-tubular="0.03"
                    material="metalness: 0.8; roughness: 0.2;"
                    animation="property: rotation; to: 0 0 360; loop: true; dur: 15000">
                </a-torus>
            </a-entity>
        </a-marker>
        
        <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ï¼ˆiOSæœ€é©åŒ–ï¼‰ -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="0 1 1" color="#ffffff" intensity="0.4"></a-light>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // iOSãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isIOSSafari = isIOS && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
        
        // DOMè¦ç´ 
        const loadingScreen = document.getElementById('loading-screen');
        const statusOverlay = document.getElementById('status-overlay');
        const instructions = document.getElementById('instructions');
        const progress = document.getElementById('progress');
        const loadingStatus = document.getElementById('loading-status');
        const errorDetails = document.getElementById('error-details');
        
        const cameraStatus = document.getElementById('camera-status');
        const arStatus = document.getElementById('ar-status');
        const markerStatus = document.getElementById('marker-status');
        const deviceStatus = document.getElementById('device-status');
        
        // åˆæœŸåŒ–çŠ¶æ…‹
        let initStep = 0;
        const maxSteps = 4;
        let initializationTimeout;
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(step, message) {
            initStep = step;
            const percentage = (step / maxSteps) * 100;
            progress.style.width = percentage + '%';
            loadingStatus.textContent = message;
            console.log(`Progress ${step}/${maxSteps}: ${message}`);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(element, message, type = 'ok') {
            element.innerHTML = element.innerHTML.split(':')[0] + ': ' + 
                `<span class="status-${type}">${message}</span>`;
        }
        
        // ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤º
        function showErrorDetails(error) {
            errorDetails.style.display = 'block';
            errorDetails.innerHTML = `
                <strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong><br>
                ${error.name}: ${error.message}<br>
                <small>ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.slice(0, 60)}...</small>
            `;
        }
        
        // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ï¼ˆiOSæœ€é©åŒ–ï¼‰
        async function initializeCamera() {
            updateProgress(1, 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªä¸­...');
            
            try {
                // iOS Safariç”¨ã®æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®š
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640, min: 480 },
                        height: { ideal: 480, min: 360 },
                        frameRate: { ideal: 30, max: 30 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                updateStatus(cameraStatus, 'ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯æ¸ˆã¿', 'ok');
                updateProgress(2, 'ã‚«ãƒ¡ãƒ©ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();
                console.log('Camera settings:', settings);
                
                // ãƒ†ã‚¹ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Camera error:', error);
                updateStatus(cameraStatus, 'ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼', 'error');
                updateProgress(2, 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showErrorDetails(error);
                return false;
            }
        }
        
        // AR.jsåˆæœŸåŒ–ï¼ˆiOSæœ€é©åŒ–ï¼‰
        function initializeAR() {
            updateProgress(3, 'AR.jsã‚’åˆæœŸåŒ–ä¸­...');
            
            const scene = document.querySelector('a-scene');
            const marker = document.querySelector('#hiro-marker');
            
            // AR.jsã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            scene.addEventListener('arjs-video-loaded', () => {
                console.log('AR.js video loaded successfully');
                updateStatus(arStatus, 'ã‚«ãƒ¡ãƒ©æ˜ åƒå–å¾—æˆåŠŸ', 'ok');
                updateProgress(4, 'ARåˆæœŸåŒ–å®Œäº†ï¼');
                
                // åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (initializationTimeout) {
                    clearTimeout(initializationTimeout);
                }
                
                // UIè¡¨ç¤º
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    statusOverlay.style.display = 'block';
                    instructions.style.display = 'block';
                }, 1000);
            });
            
            scene.addEventListener('camera-error', (event) => {
                console.error('AR.js camera error:', event.detail);
                updateStatus(arStatus, 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', 'error');
                updateProgress(3, 'ARã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–ã«å¤±æ•—');
                showErrorDetails(event.detail);
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
            marker.addEventListener('markerFound', () => {
                console.log('Hiro marker detected');
                updateStatus(markerStatus, 'æ¤œå‡ºä¸­ - ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤º', 'ok');
            });
            
            marker.addEventListener('markerLost', () => {
                console.log('Hiro marker lost');
                updateStatus(markerStatus, 'æœªæ¤œå‡º', 'warning');
            });
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤º
        function showDeviceInfo() {
            const deviceInfo = isIOSSafari ? 'iOS Safari' : 
                              isIOS ? 'iOS (ä»–ãƒ–ãƒ©ã‚¦ã‚¶)' : 
                              'ãã®ä»–ãƒ‡ãƒã‚¤ã‚¹';
            updateStatus(deviceStatus, deviceInfo, isIOSSafari ? 'ok' : 'warning');
        }
        
        // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–
        async function initialize() {
            console.log('Initializing AR Keyholder (iOS Optimized)...');
            console.log('User Agent:', navigator.userAgent);
            console.log('HTTPS:', location.protocol === 'https:');
            console.log('Host:', window.location.hostname);
            console.log('iOS Safari:', isIOSSafari);
            
            showDeviceInfo();
            
            // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
            const cameraOK = await initializeCamera();
            
            if (cameraOK) {
                // ARåˆæœŸåŒ–
                initializeAR();
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ20ç§’ã«å»¶é•·ã€iOSç”¨ï¼‰
                initializationTimeout = setTimeout(() => {
                    if (initStep < maxSteps) {
                        updateProgress(initStep, 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„');
                        updateStatus(arStatus, 'åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', 'error');
                        errorDetails.style.display = 'block';
                        errorDetails.innerHTML = `
                            <strong>åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</strong><br>
                            ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:<br>
                            â€¢ ã‚«ãƒ¡ãƒ©æ¨©é™ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹<br>
                            â€¢ ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‹<br>
                            â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå®‰å®šã—ã¦ã„ã‚‹ã‹
                        `;
                    }
                }, 20000);
            } else {
                updateProgress(2, 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    statusOverlay.style.display = 'block';
                    instructions.style.display = 'block';
                }, 2000);
            }
        }
        
        // åˆæœŸåŒ–é–‹å§‹
        document.addEventListener('DOMContentLoaded', initialize);
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼‰
        window.ARKeyholder = {
            version: '1.1.0',
            environment: 'netlify',
            optimizedFor: 'iOS Safari',
            debug: true,
            reinitialize: initialize
        };
        
        // ã‚¨ãƒ©ãƒ¼ç›£è¦–
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showErrorDetails(event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorDetails(event.reason);
        });
    </script>
</body>
</html>