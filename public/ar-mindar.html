<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Keyholder - MindAR Edition</title>
    
    <!-- MindAR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            overflow: hidden; 
            background: #000;
        }
        
        #ar-scene { 
            width: 100vw; 
            height: 100vh; 
        }
        
        #status-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        
        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .status-ok { color: #4ade80; }
        .status-error { color: #f87171; }
        .status-warning { color: #fbbf24; }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .marker-link {
            color: #60a5fa;
            text-decoration: none;
            margin-top: 10px;
            display: inline-block;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10000;
        }
        
        #debug-panel {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1001;
            max-width: 200px;
        }
        
        .debug-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading">
        <h3>ğŸ§  MindARåˆæœŸåŒ–ä¸­...</h3>
        <p>AIãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚’æº–å‚™ã—ã¦ã„ã¾ã™</p>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status-overlay" style="display: none;">
        <h3>ğŸ¯ AR Keyholder - MindAR Edition</h3>
        <div class="status-item" id="camera-status">ğŸ“· ã‚«ãƒ¡ãƒ©: <span class="status-ok">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span></div>
        <div class="status-item" id="ar-status">ğŸ§  MindAR: <span class="status-ok">æº–å‚™å®Œäº†</span></div>
        <div class="status-item" id="marker-status">ğŸ“ ãƒãƒ¼ã‚«ãƒ¼: æ¤œå‡ºå¾…æ©Ÿä¸­</div>
        <div class="status-item" id="visibility-status">ğŸ‘ï¸ è¡¨ç¤º: <span class="status-warning">å¾…æ©Ÿä¸­</span></div>
    </div>
    
    <!-- ä½¿ç”¨æ–¹æ³• -->
    <div id="instructions" style="display: none;">
        <strong>ğŸ“– ä½¿ç”¨æ–¹æ³•:</strong><br>
        1. ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã€ã¾ãŸã¯<a href="https://raw.githubusercontent.com/hiukim/mind-ar-js/master/examples/image-tracking/assets/card-example/card.png" 
              target="_blank" class="marker-link">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¼ãƒ‰</a>ã‚’ç”¨æ„<br>
        2. ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„<br>
        3. AIãŒé«˜ç²¾åº¦ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’èªè­˜ã—ã€3Dã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼<br>
        <small style="color: #ff6b6b; font-weight: bold;">â€» èªè­˜ã—ãªã„å ´åˆã¯å³ä¸‹ã®èµ¤æ ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã§ã€ŒğŸŸ¢ç°¡å˜ãƒ†ã‚¹ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—</small>
    </div>
    
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div id="debug-panel" style="display: block; position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.9); color: white; padding: 15px; border-radius: 8px; font-size: 12px; z-index: 10001; max-width: 250px; border: 3px solid #ff6b6b; box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);">
        <div style="margin-bottom: 15px; text-align: center;"><strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«</strong></div>
        
        <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
        <button onclick="simpleTest()" style="background: #28a745; color: white; border: none; padding: 8px 12px; margin: 3px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%;">ğŸŸ¢ ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
        
        <!-- åŸºæœ¬ãƒœã‚¿ãƒ³ -->
        <button onclick="showTestCube()" style="background: #007bff; color: white; border: none; padding: 6px 10px; margin: 2px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 48%; display: inline-block;">ğŸŸ¦ ã‚­ãƒ¥ãƒ¼ãƒ–è¡¨ç¤º</button>
        <button onclick="hideTestCube()" style="background: #6c757d; color: white; border: none; padding: 6px 10px; margin: 2px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 48%; display: inline-block;">âŒ ã‚­ãƒ¥ãƒ¼ãƒ–éè¡¨ç¤º</button>
        
        <button onclick="showAxis()" style="background: #17a2b8; color: white; border: none; padding: 6px 10px; margin: 2px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 48%; display: inline-block;">ğŸ¯ è»¸è¡¨ç¤º</button>
        <button onclick="hideAxis()" style="background: #6c757d; color: white; border: none; padding: 6px 10px; margin: 2px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 48%; display: inline-block;">âŒ è»¸éè¡¨ç¤º</button>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="debug-status" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 10px; line-height: 1.4;">
            <div style="color: #ffc107;">âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
            <div id="debug-info">åˆæœŸåŒ–ä¸­...</div>
        </div>
        
        <!-- æ“ä½œèª¬æ˜ -->
        <div style="margin-top: 10px; font-size: 9px; color: #aaa; text-align: center;">
            ãƒãƒ¼ã‚«ãƒ¼èªè­˜ã—ãªã„å ´åˆã¯<br>ã€Œç°¡å˜ãƒ†ã‚¹ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—
        </div>
    </div>

    <!-- MindAR Scene -->
    <a-scene
        id="ar-scene"
        mindar-image="imageTargetSrc: #defaultMarker; maxTrack: 1; filterMinCF: 0.001; filterBeta: 0.1; missTolerance: 0; warmupTolerance: 5"
        color-space="sRGB"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <!-- ã‚¢ã‚»ãƒƒãƒˆ -->
        <a-assets>
            <img id="defaultMarker" src="" crossorigin="anonymous">
        </a-assets>
        
        <!-- MindARã‚¢ãƒ³ã‚«ãƒ¼ -->
        <a-camera 
            mindar-image-camera="true"
            position="0 0 0">
        </a-camera>
        
        <!-- ãƒãƒ¼ã‚«ãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -->
        <a-entity 
            id="marker-anchor"
            mindar-image-target="targetIndex: 0"
            visible="false">
            
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <a-entity id="character-container" position="0 0 0" rotation="0 0 0" scale="1 1 1">
                
                <!-- åŸºæº–ç‚¹ï¼ˆç·‘ã®çƒï¼‰ - ãƒãƒ¼ã‚«ãƒ¼ä¸­å¿ƒç¢ºèªç”¨ -->
                <a-sphere
                    id="center-reference"
                    position="0 0 0"
                    radius="0.03"
                    color="#00ff00"
                    material="emissive: #00ff00; emissiveIntensity: 3.0; transparent: true; opacity: 0.9;"
                    visible="false">
                </a-sphere>
                
                <!-- ä½ç½®ç¢ºèªç”¨ã®è»¸è¡¨ç¤º -->
                <a-box id="x-axis" position="0.1 0 0" width="0.2" height="0.01" depth="0.01" color="#ff0000" visible="false"></a-box>
                <a-box id="y-axis" position="0 0.1 0" width="0.01" height="0.2" depth="0.01" color="#00ff00" visible="false"></a-box>
                <a-box id="z-axis" position="0 0 0.1" width="0.01" height="0.01" depth="0.2" color="#0000ff" visible="false"></a-box>
                
                <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚­ãƒ¥ãƒ¼ãƒ– -->
                <a-box
                    id="test-cube"
                    position="0 0.1 0"
                    width="0.1"
                    height="0.1"
                    depth="0.1"
                    color="#ff6b6b"
                    material="emissive: #ff6b6b; emissiveIntensity: 0.3;"
                    visible="false"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
                </a-box>
                
                <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                
            </a-entity>
        </a-entity>
        
        <!-- ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° -->
        <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
        <a-light type="directional" position="0 1 0" color="#ffffff" intensity="1.2"></a-light>
        <a-light type="point" position="0 2 1" color="#ffffff" intensity="0.8"></a-light>
    </a-scene>

    <script>
        // DOMè¦ç´ 
        const loading = document.getElementById('loading');
        const statusOverlay = document.getElementById('status-overlay');
        const instructions = document.getElementById('instructions');
        const markerStatus = document.getElementById('marker-status');
        const visibilityStatus = document.getElementById('visibility-status');
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateStatus(element, message, type = 'ok') {
            const statusClasses = { ok: 'status-ok', error: 'status-error', warning: 'status-warning' };
            element.innerHTML = element.innerHTML.split(':')[0] + ': ' + 
                `<span class="${statusClasses[type]}\">${message}</span>`;
        }
        
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://flqbgdqtphokkekminvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscWJnZHF0cGhva2tla21pbnZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjgyMjIsImV4cCI6MjA2NTE0NDIyMn0.rEXiy6TbMVflwpkDv9z1pMV6lsrmW7ukM81qGj4pfp0';
        const SUPABASE_HEADERS = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY
        };

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.ARKeyholder = {
            version: '4.0.0-mindar-debug',
            showReferences: () => {
                const ref = document.querySelector('#center-reference');
                const xAxis = document.querySelector('#x-axis');
                const yAxis = document.querySelector('#y-axis');
                const zAxis = document.querySelector('#z-axis');
                ref.setAttribute('visible', true);
                xAxis.setAttribute('visible', true);
                yAxis.setAttribute('visible', true);
                zAxis.setAttribute('visible', true);
                console.log('Reference elements visible - Green=center, Red=X, Green=Y, Blue=Z');
            },
            hideReferences: () => {
                const ref = document.querySelector('#center-reference');
                const xAxis = document.querySelector('#x-axis');
                const yAxis = document.querySelector('#y-axis');
                const zAxis = document.querySelector('#z-axis');
                ref.setAttribute('visible', false);
                xAxis.setAttribute('visible', false);
                yAxis.setAttribute('visible', false);
                zAxis.setAttribute('visible', false);
                console.log('Reference elements hidden');
            },
            adjustCharacter: (x, y, z) => {
                const container = document.querySelector('#character-container');
                if (container) {
                    container.object3D.position.set(x, y, z);
                    container.object3D.updateMatrixWorld(true);
                    console.log(`Character container moved to: ${x}, ${y}, ${z}`);
                }
            },
            debugInfo: () => {
                const anchor = document.querySelector('#marker-anchor');
                const container = document.querySelector('#character-container');
                console.log('=== MINDAR DEBUG INFO ===');
                console.log('Anchor position:', anchor.object3D.position);
                console.log('Container position:', container.object3D.position);
                console.log('Container world position:', container.object3D.getWorldPosition(new THREE.Vector3()));
                return {
                    anchor: anchor.object3D.position,
                    container: container.object3D.position,
                    containerWorld: container.object3D.getWorldPosition(new THREE.Vector3())
                };
            },
            centerTest: () => {
                console.log('Testing center position with MindAR...');
                ARKeyholder.showReferences();
                ARKeyholder.adjustCharacter(0, 0, 0);
                console.log('Green sphere = marker center');
            }
        };
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ç”¨é–¢æ•°
        let referencesVisible = false;
        
        function toggleReferences() {
            referencesVisible = !referencesVisible;
            if (referencesVisible) {
                ARKeyholder.showReferences();
                document.querySelector('#test-cube').setAttribute('visible', true);
            } else {
                ARKeyholder.hideReferences();
                document.querySelector('#test-cube').setAttribute('visible', false);
            }
        }
        
        function forceShowObject() {
            const anchor = document.querySelector('#marker-anchor');
            anchor.setAttribute('visible', true);
            toggleReferences();
            updateDebugInfo('å¼·åˆ¶è¡¨ç¤º: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            console.log('Force showing objects for position debugging');
        }
        
        function resetMarker() {
            const anchor = document.querySelector('#marker-anchor');
            anchor.setAttribute('visible', false);
            referencesVisible = false;
            ARKeyholder.hideReferences();
            document.querySelector('#test-cube').setAttribute('visible', false);
            updateDebugInfo('ãƒªã‚»ãƒƒãƒˆ: ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºå¾…æ©Ÿä¸­');
            console.log('Reset marker detection');
        }
        
        function testPosition() {
            const testCube = document.querySelector('#test-cube');
            const positions = [
                '0 0.1 0',    // ä¸­å¿ƒä¸Š
                '0.2 0.1 0',  // å³
                '-0.2 0.1 0', // å·¦  
                '0 0.1 0.2',  // æ‰‹å‰
                '0 0.1 -0.2'  // å¥¥
            ];
            
            let posIndex = 0;
            const interval = setInterval(() => {
                testCube.setAttribute('position', positions[posIndex]);
                testCube.setAttribute('visible', true);
                updateDebugInfo(`ãƒ†ã‚¹ãƒˆä½ç½®: ${positions[posIndex]}`);
                posIndex++;
                
                if (posIndex >= positions.length) {
                    clearInterval(interval);
                    testCube.setAttribute('position', '0 0.1 0'); // ä¸­å¿ƒã«æˆ»ã™
                    updateDebugInfo('ãƒ†ã‚¹ãƒˆå®Œäº†: ä¸­å¿ƒã«æˆ»ã—ã¾ã—ãŸ');
                }
            }, 1500);
        }
        
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.textContent = `[${timestamp}] ${message}`;
            }
        }
        
        // åˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugInfo('ARã‚¢ãƒ—ãƒªåˆæœŸåŒ–ä¸­...');
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã®åˆæœŸè¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹
            setTimeout(() => {
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                    debugPanel.style.visibility = 'visible';
                    console.log('Debug panel forced visible');
                }
            }, 1000);
        });
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadProjectData() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                try {
                    console.log('Loading project:', projectId);
                    
                    // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
                    let projectData;
                    const projects = JSON.parse(localStorage.getItem('ar-projects') || '[]');
                    projectData = projects.find(p => p.id === projectId);
                    
                    if (projectData) {
                        console.log('Project found in localStorage:', projectData);
                    } else {
                        // Supabaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        try {
                            const response = await fetch(`${SUPABASE_URL}/rest/v1/projects?id=eq.${projectId}&select=*`, {
                                method: 'GET',
                                headers: SUPABASE_HEADERS
                            });
                            
                            if (response.ok) {
                                const supabaseProjects = await response.json();
                                console.log('Raw Supabase project data:', supabaseProjects);
                                
                                if (supabaseProjects && supabaseProjects.length > 0) {
                                    const supabaseProject = supabaseProjects[0];
                                    
                                    // Supabaseãƒ‡ãƒ¼ã‚¿ã‚’æ—¢å­˜å½¢å¼ã«å¤‰æ›
                                    projectData = {
                                        id: supabaseProject.id,
                                        name: supabaseProject.title,
                                        metadata: { 
                                            description: supabaseProject.description || '' 
                                        },
                                        character: {
                                            modelUrl: supabaseProject.model_url || 'default',
                                            scale: supabaseProject.scale || 1,
                                            position: [
                                                supabaseProject.position_x || 0,
                                                supabaseProject.position_y || 0,
                                                supabaseProject.position_z || 0
                                            ],
                                            rotation: [
                                                supabaseProject.rotation_x || 0,
                                                supabaseProject.rotation_y || 0,
                                                supabaseProject.rotation_z || 0
                                            ]
                                        },
                                        marker: { 
                                            imageUrl: supabaseProject.image_url || '',
                                            type: 'custom' // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼
                                        },
                                        created_at: supabaseProject.created_at
                                    };
                                    
                                    console.log('Converted project data from Supabase:', projectData);
                                }
                            } else {
                                console.warn('Supabase fetch failed:', response.status, response.statusText);
                            }
                        } catch (supabaseError) {
                            console.warn('Supabase connection error:', supabaseError);
                        }
                    }
                    
                    if (projectData) {
                        await applyProjectSettings(projectData);
                        updateStatus(document.getElementById('ar-status'), `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectData.name}`, 'ok');
                        
                        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                        loading.style.display = 'none';
                        statusOverlay.style.display = 'block';
                        instructions.style.display = 'block';
                    } else {
                        console.warn('Project not found:', projectId);
                        updateStatus(document.getElementById('ar-status'), 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨
                        await useDefaultMarker();
                    }
                } catch (error) {
                    console.error('Project loading error:', error);
                    updateStatus(document.getElementById('ar-status'), 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                    await useDefaultMarker();
                }
            } else {
                console.log('No project ID specified, using default marker');
                await useDefaultMarker();
            }
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨
        async function useDefaultMarker() {
            const defaultMarkerUrl = 'https://raw.githubusercontent.com/hiukim/mind-ar-js/master/examples/image-tracking/assets/card-example/card.png';
            
            try {
                // ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = defaultMarkerUrl;
                });
                
                document.querySelector('#defaultMarker').src = defaultMarkerUrl;
                updateStatus(document.getElementById('ar-status'), 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ä½¿ç”¨', 'warning');
                console.log('Default marker loaded successfully');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                loading.style.display = 'none';
                statusOverlay.style.display = 'block';
                instructions.style.display = 'block';
                
            } catch (error) {
                console.error('Default marker loading failed:', error);
                updateStatus(document.getElementById('ar-status'), 'ãƒãƒ¼ã‚«ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ï¼‰
                loading.style.display = 'none';
                statusOverlay.style.display = 'block';
                instructions.style.display = 'block';
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã®é©ç”¨
        async function applyProjectSettings(projectData) {
            try {
                console.log('Applying project settings with MindAR:', projectData);
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã®è¨­å®š
                if (projectData.marker && projectData.marker.imageUrl && projectData.marker.imageUrl !== '') {
                    console.log('Setting custom marker:', projectData.marker.imageUrl);
                    
                    try {
                        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                            img.src = projectData.marker.imageUrl;
                        });
                        
                        document.querySelector('#defaultMarker').src = projectData.marker.imageUrl;
                        console.log('Custom marker loaded successfully');
                    } catch (markerError) {
                        console.warn('Custom marker loading failed, using default:', markerError);
                        await useDefaultMarker();
                        return;
                    }
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨
                    await useDefaultMarker();
                    return;
                }
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š
                if (projectData.character && projectData.character.modelUrl) {
                    const modelUrl = projectData.character.modelUrl;
                    console.log('Loading character model:', modelUrl);
                    
                    if (modelUrl && modelUrl !== 'default' && modelUrl !== '') {
                        const characterContainer = document.querySelector('#character-container');
                        
                        // Base64ãƒ‡ãƒ¼ã‚¿ã‹URLã‹ã‚’åˆ¤å®š
                        let modelSrc = modelUrl;
                        if (modelUrl.startsWith('data:application/octet-stream')) {
                            console.log('Loading Base64 GLB model');
                            modelSrc = modelUrl;
                        } else if (modelUrl.startsWith('http')) {
                            console.log('Loading external GLB model from URL');
                            modelSrc = modelUrl;
                        } else if (modelUrl.startsWith('large-glb-local-')) {
                            console.log('Loading large local GLB model');
                            const glbData = localStorage.getItem(`glb-data-${projectData.id}`);
                            if (glbData) {
                                modelSrc = glbData;
                                console.log('Large GLB data retrieved from localStorage');
                            } else {
                                console.warn('Large GLB data not found in localStorage');
                                return;
                            }
                        }
                        
                        // GLTFãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
                        const gltfEntity = document.createElement('a-gltf-model');
                        gltfEntity.setAttribute('src', modelSrc);
                        
                        // 3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§èª¿æ•´ã•ã‚ŒãŸä½ç½®ãƒ»å›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ã‚’é©ç”¨
                        const position = projectData.character.position ? 
                            `${projectData.character.position[0]} ${projectData.character.position[1]} ${projectData.character.position[2]}` : 
                            '0 0 0';
                        
                        const rotation = projectData.character.rotation ? 
                            `${projectData.character.rotation[0]} ${projectData.character.rotation[1]} ${projectData.character.rotation[2]}` : 
                            '0 0 0';
                        
                        const scale = projectData.character.scale || 1;
                        
                        gltfEntity.setAttribute('position', position);
                        gltfEntity.setAttribute('scale', `${scale} ${scale} ${scale}`);
                        gltfEntity.setAttribute('rotation', rotation);
                        
                        console.log('Applied 3D preview settings:', {
                            position: position,
                            rotation: rotation,
                            scale: scale
                        });
                        
                        // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
                        gltfEntity.addEventListener('model-loaded', () => {
                            console.log('âœ… Character model loaded successfully with MindAR');
                            updateStatus(document.getElementById('ar-status'), `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†: ${projectData.name}`, 'ok');
                        });
                        
                        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                        gltfEntity.addEventListener('model-error', (event) => {
                            console.error('âŒ Character model loading failed:', event.detail);
                            updateStatus(document.getElementById('ar-status'), 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                            gltfEntity.remove();
                        });
                        
                        characterContainer.appendChild(gltfEntity);
                        console.log('Character model entity created with MindAR');
                    } else {
                        console.log('No character model specified');
                        updateStatus(document.getElementById('ar-status'), 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã—', 'ok');
                    }
                }
                
            } catch (error) {
                console.error('Error applying project settings:', error);
                updateStatus(document.getElementById('ar-status'), 'è¨­å®šé©ç”¨ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }
        
        // ARè¡¨ç¤ºå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        function incrementViewCount() {
            const currentViews = parseInt(localStorage.getItem('ar-total-views') || '0');
            localStorage.setItem('ar-total-views', (currentViews + 1).toString());
            console.log('AR view count incremented:', currentViews + 1);
        }
        
        // MindARåˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ§  MindAR Keyholder - AI-powered AR tracking');
            
            const arScene = document.querySelector('a-scene');
            const markerAnchor = document.querySelector('#marker-anchor');
            
            // MindARåˆæœŸåŒ–å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
            arScene.addEventListener('renderstart', () => {
                console.log('ğŸš€ MindAR scene initialized');
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã®ã¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                if (loading.style.display !== 'none') {
                    loading.style.display = 'none';
                    statusOverlay.style.display = 'block';
                    instructions.style.display = 'block';
                }
                updateStatus(markerStatus, 'æ¤œå‡ºå¾…æ©Ÿä¸­', 'warning');
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
            markerAnchor.addEventListener('targetFound', () => {
                console.log('ğŸ¯ MindAR marker detected - Character display!');
                updateStatus(markerStatus, 'æ¤œå‡ºä¸­ - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º!', 'ok');
                updateStatus(visibilityStatus, 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºä¸­!', 'ok');
                updateDebugInfo('ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºä¸­');
                
                markerAnchor.setAttribute('visible', true);
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã¯å¸¸æ™‚è¡¨ç¤ºæ¸ˆã¿
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ã«å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const characterModels = markerAnchor.querySelectorAll('a-gltf-model');
                characterModels.forEach(model => {
                    model.setAttribute('animation__appear', {
                        property: 'scale',
                        from: '0 0 0',
                        to: model.getAttribute('scale'),
                        dur: 800,
                        easing: 'easeOutQuad'
                    });
                });
            });
            
            markerAnchor.addEventListener('targetLost', () => {
                console.log('MindAR marker lost');
                updateStatus(markerStatus, 'æœªæ¤œå‡º - ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™', 'warning');
                updateStatus(visibilityStatus, 'å¾…æ©Ÿä¸­', 'warning');
                markerAnchor.setAttribute('visible', false);
            });
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadProjectData();
            incrementViewCount();
            
            console.log('MindAR setup complete - enhanced tracking ready!');
        });
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ãƒãƒƒã‚°é–¢æ•°
        function simpleTest() {
            try {
                console.log('=== ç°¡å˜ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
                updateDebugInfo('ç°¡å˜ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
                
                // ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å¼·åˆ¶è¡¨ç¤º
                const anchor = document.querySelector('#marker-anchor');
                if (anchor) {
                    anchor.setAttribute('visible', 'true');
                    console.log('ã‚¢ãƒ³ã‚«ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                }
                
                // ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–ã‚’è¡¨ç¤º
                const testCube = document.querySelector('#test-cube');
                if (testCube) {
                    testCube.setAttribute('visible', 'true');
                    testCube.setAttribute('position', '0 0.2 0');
                    console.log('ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                }
                
                // åŸºæº–ç‚¹ã‚’è¡¨ç¤º
                const centerRef = document.querySelector('#center-reference');
                if (centerRef) {
                    centerRef.setAttribute('visible', 'true');
                    console.log('ä¸­å¿ƒåŸºæº–ç‚¹ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                }
                
                updateDebugInfo('ç°¡å˜ãƒ†ã‚¹ãƒˆå®Œäº†: èµ¤ã‚­ãƒ¥ãƒ¼ãƒ–ã¨ç·‘çƒãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                console.log('=== ç°¡å˜ãƒ†ã‚¹ãƒˆå®Œäº† ===');
                
            } catch (error) {
                console.error('ç°¡å˜ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateDebugInfo('ç°¡å˜ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼');
            }
        }
        
        function showTestCube() {
            try {
                const testCube = document.querySelector('#test-cube');
                const anchor = document.querySelector('#marker-anchor');
                
                if (anchor) anchor.setAttribute('visible', 'true');
                if (testCube) {
                    testCube.setAttribute('visible', 'true');
                    updateDebugInfo('ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–è¡¨ç¤º');
                    console.log('ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–è¡¨ç¤º');
                }
            } catch (error) {
                console.error('showTestCube error:', error);
            }
        }
        
        function hideTestCube() {
            try {
                const testCube = document.querySelector('#test-cube');
                if (testCube) {
                    testCube.setAttribute('visible', 'false');
                    updateDebugInfo('ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–éè¡¨ç¤º');
                    console.log('ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–éè¡¨ç¤º');
                }
            } catch (error) {
                console.error('hideTestCube error:', error);
            }
        }
        
        function showAxis() {
            try {
                const elements = ['#center-reference', '#x-axis', '#y-axis', '#z-axis'];
                const anchor = document.querySelector('#marker-anchor');
                
                if (anchor) anchor.setAttribute('visible', 'true');
                
                elements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) element.setAttribute('visible', 'true');
                });
                
                updateDebugInfo('è»¸ã¨åŸºæº–ç‚¹è¡¨ç¤º');
                console.log('è»¸ã¨åŸºæº–ç‚¹è¡¨ç¤º');
            } catch (error) {
                console.error('showAxis error:', error);
            }
        }
        
        function hideAxis() {
            try {
                const elements = ['#center-reference', '#x-axis', '#y-axis', '#z-axis'];
                
                elements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) element.setAttribute('visible', 'false');
                });
                
                updateDebugInfo('è»¸ã¨åŸºæº–ç‚¹éè¡¨ç¤º');
                console.log('è»¸ã¨åŸºæº–ç‚¹éè¡¨ç¤º');
            } catch (error) {
                console.error('hideAxis error:', error);
            }
        }
    </script>
</body>
</html>